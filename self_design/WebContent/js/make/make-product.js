var locale = {
	ko: {
		"업로드중...": "업로드중...",
		"이미지 불러오기": "이미지 불러오기",
		"이미지가 너무 커서 3000픽셀 이하로 줄여서 저장했습니다.^^": "이미지가 너무 커서 3000픽셀 이하로 줄여서 저장했습니다.^^",
		"로그인 하시면 나만의 이미지를 사용하실 수 있습니다.": "로그인 하시면 나만의 이미지를 사용하실 수 있습니다.",
		"전체": "전체",
		"무료 디자인": "무료 디자인",
		"디자이너 스토어": "디자이너 스토어",
		"사용중인 이미지는 삭제할 수 없습니다.": "사용중인 이미지는 삭제할 수 없습니다.",
		"삭제하시겠습니까?": "삭제하시겠습니까?",
		"로그인하시면 텍스트를 추가하실 수 있습니다.": "로그인하시면 텍스트를 추가하실 수 있습니다.",
		"텍스트 넣는 중...": "텍스트 넣는 중...",
		"텍스트 넣기": "텍스트 넣기",
		"기본 가격 %s원": "기본 가격 %s원",
		"%s 인쇄 %s원": "%s 인쇄 %s원",
		"컬러티셔츠 인쇄 %s원": "컬러티셔츠 인쇄 %s원",
		"인쇄할 티셔츠가 컬러인 경우에 추가되는 가격입니다. (블랙 포함)": "인쇄할 티셔츠가 컬러인 경우에 추가되는 가격입니다. (블랙 포함)",
		"디자이너 스토어 %s원": "디자이너 스토어 %s원",
		"합계 %s원": "합계 %s원",
		"수량 %s개": "수량 %s개",
		"한면에 디자인을 3개 이상 추가할 수 없습니다.": "한면에 디자인을 3개 이상 추가할 수 없습니다.",
		"아이템을 하나만 선택하신 후 다시 시도해주세요.": "아이템을 하나만 선택하신 후 다시 시도해주세요.",
		"흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.": "흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.",
		"상품 수량 변경시 에러가 발생하였습니다.": "상품 수량 변경시 에러가 발생하였습니다.",
		"삭제시 에러가 발생하였습니다.": "삭제시 에러가 발생하였습니다.",
		"인쇄 영역을 넘어간 이미지가 있습니다.": "인쇄 영역을 넘어간 이미지가 있습니다.",
		"수량을 입력해주세요.": "수량을 입력해주세요.",
		"담는중...": "담는중...",
		"장바구니 담기": "장바구니 담기"
	},
	en: {
		"업로드중...": "업로드중...",
		"이미지 불러오기": "이미지 불러오기",
		"이미지가 너무 커서 3000픽셀 이하로 줄여서 저장했습니다.^^": "이미지가 너무 커서 3000픽셀 이하로 줄여서 저장했습니다.^^",
		"로그인 하시면 나만의 이미지를 사용하실 수 있습니다.": "로그인 하시면 나만의 이미지를 사용하실 수 있습니다.",
		"전체": "All",
		"무료 디자인": "Free Design",
		"디자이너 스토어": "Designer Store",
		"사용중인 이미지는 삭제할 수 없습니다.": "사용중인 이미지는 삭제할 수 없습니다.",
		"삭제하시겠습니까?": "삭제하시겠습니까?",
		"로그인하시면 텍스트를 추가하실 수 있습니다.": "로그인하시면 텍스트를 추가하실 수 있습니다.",
		"텍스트 넣는 중...": "텍스트 넣는 중...",
		"텍스트 넣기": "텍스트 넣기",
		"기본 가격 %s원": "Base Price $%s",
		"%s 인쇄 %s원": "%s Print $%s",
		"컬러티셔츠 인쇄 %s원": "Color T Print $%s",
		"인쇄할 티셔츠가 컬러인 경우에 추가되는 가격입니다. (블랙 포함)": "인쇄할 티셔츠가 컬러인 경우에 추가되는 가격입니다. (블랙 포함)",
		"디자이너 스토어 %s원": "Designer Store $%s",
		"합계 %s원": "All $%s",
		"수량 %s개": "Count %s",
		"한면에 디자인을 3개 이상 추가할 수 없습니다.": "Design on one side, you can not add more than 3.",
		"아이템을 하나만 선택하신 후 다시 시도해주세요.": "아이템을 하나만 선택하신 후 다시 시도해주세요.",
		"흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.": "흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.",
		"상품 수량 변경시 에러가 발생하였습니다.": "상품 수량 변경시 에러가 발생하였습니다.",
		"삭제시 에러가 발생하였습니다.": "삭제시 에러가 발생하였습니다.",
		"인쇄 영역을 넘어간 이미지가 있습니다.": "인쇄 영역을 넘어간 이미지가 있습니다.",
		"수량을 입력해주세요.": "수량을 입력해주세요.",
		"담는중...": "...",
		"장바구니 담기": "Add to Cart"
	}
};

$.ajaxSetup({ cache: false });

function l() {
	var key = arguments[0];
	var cl = $('body').attr('data-locale');
	var template = locale[cl][key];
	if (arguments.length == 1) return template;
	var values = _.rest(arguments);
	_.each(values, function(value) {
		template = template.replace('%s', value);
	});
	return template;
}

var keys = [37, 38, 39, 40];

function preventDefault(e) {
	e = e || window.event;
	if (e.preventDefault)
		e.preventDefault();
	e.returnValue = false;
}

function keydown(e) {
	for (var i = keys.length; i--;) {
		if (e.keyCode === keys[i]) {
			preventDefault(e);
			return;
		}
	}
}

function wheel(e) {
	preventDefault(e);
}

function disable_scroll() {
	if (window.addEventListener) {
		window.addEventListener('DOMMouseScroll', wheel, false);
	}
	window.onmousewheel = document.onmousewheel = wheel;
	document.onkeydown = keydown;
}

function enable_scroll() {
	if (window.removeEventListener) {
		window.removeEventListener('DOMMouseScroll', wheel, false);
	}
	window.onmousewheel = document.onmousewheel = document.onkeydown = null;
}

function getInternetExplorerVersion() {
	var rv = -1; // Return value assumes failure.
	if (navigator.appName == 'Microsoft Internet Explorer') {
		var ua = navigator.userAgent;
		var re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null)
			rv = parseFloat(RegExp.$1);
	}
	return rv;
}
function checkVersion() {
	var msg = "You're not using Windows Internet Explorer.";
	var ver = getInternetExplorerVersion();
	if (ver > -1) {
		if (ver >= 8.0)
			msg = "You're using a recent copy of Windows Internet Explorer."
		else
			msg = "You should upgrade your copy of Windows Internet Explorer.";
	}
	alert(msg);
}

var mp = mp || { log: function() {
	var ver = getInternetExplorerVersion();
	if (ver > -1) {
		if (ver <= 8.0)
			return;
	}
	_.each(arguments, function(arg) {
//		console.log(arg);
	});
}};

function commify(n) {
	var reg = /(^[+-]?\d+)(\d{3})/;   // 정규식
	n += '';                          // 숫자를 문자열로 변환

	while (reg.test(n))
		n = n.replace(reg, '$1' + ',' + '$2');

	return n;
}


function showAlert(msg) {
	var $alert = $('.mp-alert');
	if ($alert.is('.animating')) return;

	$alert
		.addClass('animating')
		.html(msg)
		.animate({ top: 0 }, 200, function() {
			setTimeout(function() {
				$alert.animate({ top: -80 }, 500, function() {
					$alert.html('').removeClass('animating');
				});
			}, 2000)
		});
}

$.widget('mp.designsController', {

	options: {
		api: '/make_product/free_designs',
		loaded: false,
		$currentCategory: null,
		loading: false
	},

	_create: function() {
		if ($('#mp-login-user-id').text().length) {
			this._on(this.element, {
				'click .mp-design, .designerBox .choice': '_select',
				'click .category .mp-category': '_categoryClick',
				'click .premiumCategory .mp-category': '_premiumCategoryClick',
				'click div.remove': '_editable'
			});
		} else {
			this._on(this.element, {
				'click .mp-design, .designerBox .choice': '_select',
				'click .category .mp-category': '_categoryClick',
				'click .premiumCategory .mp-category': '_premiumCategoryClick'
			});
		}

//		this._listView = new infinity.ListView(this.element.find('.mp-designs'));
		this.element.find('.mp-designs-container').scroll($.proxy(this._scroll, this));

		var self = this;

		if ($('#mp-login-user-id').text().length) {
			var $imageFile = this.element.find('#image-file');
			$imageFile
				.bind('fileuploadsend', function (e, data) {
					$('.btnLoadImage span').text(l('업로드중...'));
				})
				.fileupload({
					forceIframeTransport: true,
					url: $imageFile.parents('form').attr('action'),
					dataType: 'text',
					done: function(e, data) {
						$('.btnLoadImage span').text(l('이미지 불러오기'));
						var json = JSON.parse(data.result);
						if (json.result == 1) {
							showAlert(l('이미지가 너무 커서 3000픽셀 이하로 줄여서 저장했습니다.^^'));
							self.load();
						} else {
							self.load();
						}

					}
				})
				.prop('disabled', !$.support.fileInput);
		} else {
			var $imageFile = this.element.find('#image-file');
			$imageFile.remove();

			this.element.find('#loadImageBox .buttons span.btnLoadImage').click(function() {
				showAlert(l('로그인 하시면 나만의 이미지를 사용하실 수 있습니다.'));
			});
		}

		this.load();

		if (!this.element.is('#freeDesignLayer')) return;

		//디자인 > 무료 디자인
		$.get('/make_product/category/designs', _.bind(function(categories) {
//			_.each(categories, function(category) {
			_.each(categories.data, function(category) {
				$('<li class="mp-category" ' +
					'data-id="' + category.id + '"' +
					'data-group="' + category.group + '"' +
					'data-code="' + category.code + '"' +
					'>' + category[name_locale] + '' + '</li>')
					.appendTo(this.element.find('.mp-categories'));
			}, this);
			this.element.find('.mp-categories .mp-category:eq(9)').click();
		}, this));

		var group = 'DESIGN_PRICE_' + $('body').attr('data-locale').toUpperCase();
		$.post('/make_product/get_common_data', {
			group: group
		}, _.bind(function(categories) {
//			_.each(categories, function(category) {
			_.each(categories.data, function(category) {
				$('<li class="mp-category" ' +
					'data-id="' + category.id + '"' +
					'data-group="price"' +
					'data-code="' + category.code + '"' +
					'>' + category[name_locale] + '</li>')
					.appendTo(this.element.find('.mp-premium-categories'));
			}, this);
		}, this));
	},

	_editable: function(e) {
		if (this.element.attr('data-remove') == 'on') {
			this.element.attr('data-remove', '');
		} else {
			this.element.attr('data-remove', 'on');
		}
	},

	_categoryClick: function(e) {
		var $category = $(e.currentTarget);
		this.options.$currentCategory = $category;
		var text = $category.attr('data-code') == '' ? l('전체') : $category.text();
		this.element.find('.mp-category-heading').text(l('무료 디자인') + ' - ' + text);

		$.get(this.option('api') + '?type=TY002&limit=64',
			_.object([$category.attr('data-group').toLowerCase()], [$category.attr('data-code')]),
			_.bind(function(products) {
				this.element.find('.mp-designs').html('');
				var $container = this.element.find('.mp-designs-container');
				$container.scrollTop(0);
				this.options.loaded = false;
//				this._draw(products, function() {});
				this._draw(products.data, function() {});
			}, this));
	},

	_premiumCategoryClick: function(e) {
		var $category = $(e.currentTarget);
		this.options.$currentCategory = $category;
		var text = $category.attr('data-code') == '' ? l('전체') : $category.text();
		this.element.find('.mp-category-heading').text(l('디자이너 스토어') + ' - ' + text);

		// 전체, 혹은 가격으로 api 요청
		$.get(this.option('api') + '?type=TY001&limit=64',
			_.object([$category.attr('data-group').toLowerCase()], [$category.attr('data-code')]),
			_.bind(function(products) {
				this.element.find('.mp-designs').html('');
				var $container = this.element.find('.mp-designs-container');
				$container.scrollTop(0);
				this.options.loaded = false;
//				this._draw(products, function() {});
				this._draw(products.data, function() {});
			}, this));
	},

	load: function() {
		this.element.find('.mp-designs').html('');
		var $container = this.element.find('.mp-designs-container');
		$container.scrollTop(0);
		this.options.loaded = false;

//		$('#freeDesignLayer').designsController('showImage');
//		$('#loadImageWrapper').designsController('showImage');

		var type;
		if (this.element.is('#loadImageWrapper')) {
			type = 'TY003';
		} else {
			type = 'TY002';
		}

		$.get(this.option('api'), {
			limit: 64,
			type: type,
			time: new Date().getTime()
		}, $.proxy(this._draw, this));
	},

	_draw: function(items, isFirst) {
		var html = '';
//		var listView = new infinity.ListView(this.element.find('.mp-designs'));
//		_.each(items, function(item) {
//			html =
//				'<li class="mp-design" ' +
//					'data-id="' + item.id + '" ' +
//					'data-description="' + item.description + '"' +
//					'data-title="' + item.title + '">' +
//					'<img data-src="' + item.filepath.replace('_thumbnail.png', '.png') + '"' +
//					' src="' + item.filepath + '" alt="' + item.title  + '"/>' +
//				'</li>';
//			this._listView.append(html);
//		}, this);

		_.each(items, function(item) {
			html +=
				'<li class="mp-design" ' +
					'data-id="' + item.id + '" ' +
					'data-description="' + item.description + '"' +
					'data-price="' + item[price_locale] + '"' +
					'data-price-en="' + item.price_en + '"' +
					'data-price-ko="' + item.price_ko + '"' +
					'data-title="' + item.title + '"' +
					'data-width="' + item.width + '"' +
					'data-height="' + item.height + '">' +
					'<img data-src="' + item.filepath.replace('_thumbnail.png', '.png') + '"' +
						'src="' + item.filepath + '" alt="' + item.title  + '"/>' +
					(this.element.is('#freeDesignLayer') ? '' : '<img src="/img/icons/glyphicons_197_remove.png" class="remove" title="삭제">') +
					(item[price_locale] > 0 ? '<span>' + commify(item[price_locale]) + '</span>' : '') +
				'</li>';
		}, this);
		this.element.find('.mp-designs').append(html);

		enable_scroll();

		if (!this.options.loaded) {
			this.showImage();
			this.options.loaded = true;
		}

		this.option('loading', false);

//		if (this.element.find('.designerBox').length)
//			this.element.find('.mp-designs .mp-design:eq(0)').click();
	},

	_scroll: function(e) {
		var $container = this.element.find('.mp-designs-container');

		// 가릴것 가리기고
		// 보여줄 것 보여주기
		var scrollTop = $container.scrollTop();
		var scrollHeight = $container.height();

		this.showImage();

		if (this.option('loading')) return;
		if (scrollTop + scrollHeight > $container[0].scrollHeight - 90) {
			disable_scroll();

			var type;
			if (this.element.is('#loadImageWrapper')) {
				type = 'TY003';
			} else {
				if (this.options.$currentCategory && this.options.$currentCategory.parents('.premiumCategory').length) {
					type = 'TY001';
				} else {
					type = 'TY002';
				}
			}
			if (this.options.$currentCategory && this.options.$currentCategory.length) {
				$.get(this.option('api') + '?type=' + type + '&limit=32&skip=' + this.element.find('.mp-design').length,
					_.object([this.options.$currentCategory.attr('data-group').toLowerCase()], [this.options.$currentCategory.attr('data-code')]),
					$.proxy(this._draw, this));
			} else {
				$.get(this.option('api') + '?type=' + type + '&limit=32&skip=' + this.element.find('.mp-design').length, $.proxy(this._draw, this));
			}
		}
	},

	showImage: function() {
		var $container = this.element.find('.mp-designs-container');
		var scrollTop = $container.scrollTop();
		var scrollHeight = $container.height();
		this.element.find('.mp-design').removeClass('show');
		var rowCount = this.element.find('.mp-designs').width() > 310 ? 4 : 3;
		this.element.find('.mp-design:nth-child(1n+' + Math.max(parseInt(scrollTop / 100) * rowCount - 4, 0) + '):not(:nth-child(1n+' + (parseInt((scrollTop+scrollHeight) / 100) * rowCount + 8) + '))').addClass('show');
	},

	_select: function(e) {
		if ($(e.currentTarget).is('.choice')) {
			this._selectForButton(e);
			return;
		}

		var $design;
		if (this.element.is('[data-remove="on"]')) {
			var $usedDesigns = $('.mp-editor-canvas .goods-item.design img');
			$design = $(e.currentTarget);

			for	(var i = 0; i < $usedDesigns.length; i++) {
				if ($($usedDesigns[i]).attr('data-id') == $design.attr('data-id')) {
					showAlert(l('사용중인 이미지는 삭제할 수 없습니다.'));
					return;
				}
			}

			if (confirm(l('삭제하시겠습니까?'))) {

				$.get('/make_product/design/' + $design.attr('data-id') + '/remove', function(data) {
					if (data.result == -1) {
						showAlert(data.message);
						return;
					}
					showAlert(data.message);
					$design.remove();
				});
			}
			return;
		}

		$design = $(e.currentTarget);
		var $img = $design.find('img');

//		var $designerBox = this.element.find('.designerBox');
//		if ($designerBox.length) {
//			console.log('hi')
//			$designerBox
//				.attr('data-id', $design.attr('data-id'))
//				.find('.designerProfileImage img').attr('src', $img.attr('src')).end()
//				.find('.pdtName').text($design.attr('data-title')).end()
//				.find('.desc').html($design.attr('data-description')).end();
//		} else {
			$('.mp-editor').editor('addItem', {
				type: 'design',
				src: $img.attr('data-src'),
				id: $design.attr('data-id'),
				originalWidth: $design.attr('data-width'),
				originalHeight: $design.attr('data-height'),
				price: parseInt($design.attr('data-price')),
				price_ko: parseInt($design.attr('data-price-ko')),
				price_en: parseInt($design.attr('data-price-en')),
				text: $design.data('text'),
				font: $design.data('font'),
				color: $design.data('color'),
				mine: this.element.is('#loadImageWrapper')
			});

			if (!this.element.is('#loadImageWrapper')) {
				$.get('/make_product/design/' + $design.attr('data-id') + '/update_view_count', function() {});
			}
//		}
	},

	_selectForButton: function(e) {
//		var $designerBox = this.element.find('.designerBox');
//		var $img = $designerBox.find('.designerProfileImage img');
//		$('.mp-editor').editor('addItem', { type: 'design', src: $img.attr('src'), id: $designerBox.attr('data-id') });
	}

});

$.widget('mp.textController', {

	options: {
		time: 0,
		timeout: null,
		path: ''
	},

	_create: function() {
		if ($('#mp-login-user-id').text().length) {
			this._on(this.element, {
				'click .mp-text-align .icon': '_changeAlign',
				'keydown .mp-text-value': '_keydown',
				'click .mp-text-colors .color': '_changeColor',
				'click button.add': '_add',
				'click .mp-selected-font .img': '_onFontSelector',
				'click .mp-font-selector li': '_selectFont',
				'click .mp-font-selector .selector-close': '_onFontSelector'
			});
			this.element.find('.mp-font-selector li:first').click();
		} else {
			this.element.find('.mp-text-value').attr('disabled', 'disabled');
			this.element.click(function(e) {
				if (!$(e.target).is('.close, .close img')) {
					showAlert(l('로그인하시면 텍스트를 추가하실 수 있습니다.'));
				}
			});
		}
	},

	_keydown: function(e) {
		if (this.options.timeout) {
			clearTimeout(this.options.timeout);
			this.options.timeout = null;
		}
		var self = this;
		this.options.timeout = setTimeout(function() {
			$.post('/mygm/text', {
				text: self.element.find('.mp-text-value').val(),
				path: self.option('path').split('?')[0],
				textAlign: self.element.find('.mp-text-value').css('textAlign'),
				font: self.element.find('.mp-font-selector li.selected').attr('data-font-path'),
				color: self.element.find('.mp-text-colors .color.current').css('backgroundColor')
			}, function(data) {
				if ($.trim(self.element.find('.mp-text-value').val()).length == 0) {
					self.element.find('.mp-text-preview').removeClass('has');
					self.option('path', undefined);
				} else {
					var path = data.path.split('?')[0] + '?' + (new Date()).getTime();
					self.element.find('.mp-text-preview img').attr('src', path);
					self.element.find('.mp-text-preview').addClass('has');
					self.option('path', path);
				}
			});
			clearTimeout(self.options.timeout);
			self.options.timeout = null;
		}, e ? 800 : 0);
		this.option('time', (new Date()).getTime());
	},

	_selectFont: function(e) {
		var $selectedFont = $(e.currentTarget);
		if ($selectedFont.is('.selected')) return;

		this.element.find('.mp-font-selector li.selected').removeClass('selected');
		$selectedFont.addClass('selected');
		this.element.find('.mp-selected-font img').attr('src', $selectedFont.find('img').attr('src'));

		this._changeFont();
	},

	_onFontSelector: function() {
		this.element.find('.mp-font-selector').toggleClass('on')
	},

	_changeFont: function() {
		this._keydown();
	},

	_changeColor: function(e) {
		this.element.find('.mp-text-colors .color.current').removeClass('current');
		$(e.currentTarget).addClass('current');
		this._keydown();
	},

	_changeAlign: function(e) {
		this.element.find('.mp-text-align .icon').removeClass('selected');
		var $align = $(e.currentTarget);
		$align.addClass('selected');
		this.element.find('.mp-text-value').css({
			textAlign: $align.attr('data-align')
		});
		this._keydown();
	},

	_add: function() {
		if (!$.trim(this.element.find('.mp-text-value').val())) return;
		var self = this;
		this.element.find('.mp-text-value').attr('disable', true);
		var $button = this.element.find('button.add');
		$button.get(0).disabled = 'disabled';
		$button.find('.value').text(l('텍스트 넣는 중...'));
		var text = this.element.find('.mp-text-value').val();
		var font = this.element.find('.mp-font-selector li.selected').attr('data-font-path');
		var color = this.element.find('.mp-text-colors .color.current').css('backgroundColor');
		$.post('/make_product/design_by_text', {
			text: text,
			textAlign: this.element.find('.mp-text-value').css('textAlign'),
			font: font,
			color: color
		}, function(data) {
			self.element.find('.mp-text-value').val('');
			self.element.find('.mp-text-value').attr('disable', false);
			self.element.find('.mp-text-preview').removeClass('has');
			$('#loadImageWrapper').designsController('load');

			$('.mp-editor').editor('addItem', {
				type: 'design',
				src: data.design.filepath,
				id: data.design.id,
				price: 0,
				price_en: 0,
				price_ko: 0,
				text: text,
				font: font,
				color: color,
				mine: true
			});

			$button.get(0).disabled = '';
			$button.find('.value').text(l('텍스트 넣기'));
		});
	}

});

$.widget('mp.productsController', {

	options: {
		query: null,
		category: 'all',
		selectedProduct: {},
		selectedColorCode: ''
	},

	_create: function() {
		this._on(this.element, {
			'click .mp-product': '_select',
			'click .button button': '_buttonClick',
			'click .mp-category': '_categoryClick'
		});

		this._on($('.mp-product-detail-colors'), {
			'click .color': 'selectColor'
		});

		var self = this;
		this._load(function() {
			// 첫번째 프로덕트로 콜날려 불러오기
			if (self.option('query') && self.option('query').base_product) {
				var baseProductId = self.option('query').base_product;
			} else if (self.option('query') && self.option('query').product) {
				var productId = self.option('query').product;
				$.get('/make_product/product/' + productId, function(data) {
					var product = data.product;
					var selectedSize = data.product_detail.size;
					var selectedColorCode = data.product_detail.color;
					var baseProductId = product.base_productId;
					$.get('/product/' + productId + '/designs', function(designs) {
						$.get('/make_product/base_product/' + baseProductId, function(baseProduct) {
							self.option('selectedProduct', baseProduct);
							$('.mp-editor').editor('option', 'selectedColorCode', selectedColorCode);
							$('.mp-editor').editor('option', 'selectedSize', selectedSize);
							$('.mp-editor').editor('baseProduct', self.option('selectedProduct'), function() {
								$('.mp-editor').editor('drawDesigns', designs);
							});
						});
					});
				});
				return;
			} else {
				var baseProductId = $('.mp-product:eq(0)').attr('data-id');
			}
			$.get('/make_product/base_product/' + baseProductId, function(product) {
//				self.option('selectedProduct', product);
				self.option('selectedProduct', product.data[0]);//TODO 메인 상품 display, 화면이 시작
				$('.mp-editor').editor('baseProduct', self.option('selectedProduct'));
			});
		});

		//상품선택 > 전체 카테고리
		$.get('/make_product/category/catalogs', _.bind(function(categories) {
//			_.each(categories, function(category) {
			_.each(categories.data, function(category) {
				$('<li class="mp-category" ' +
					'data-id="' + category.id + '"' +
					'data-group="' + category.group + '"' +
					'data-code="' + category.code + '"' +
					'>' + category[name_locale] + '' + '</li>')
						.appendTo(this.element.find('.tab.category .category'));
			}, this);
		}, this));

		//상품선택 > 주제별 카테고리
		$.get('/make_product/category/topics', _.bind(function(categories) {
//			_.each(categories, function(category) {
			_.each(categories.data, function(category) {
				$('<li class="mp-category" ' +
					'data-id="' + category.id + '"' +
					'data-group="' + category.group + '"' +
					'data-code="' + category.code + '"' +
					'>' + category[name_locale] + '' + '</li>')
					.appendTo(this.element.find('.tab.products .products'));
			}, this);
		}, this));
	},

	_categoryClick: function(e) {
		e.preventDefault();

		var $category = $(e.currentTarget);
		var text = $category.text();
//		text = text == '전체' ? text : $category.parent().attr('data-group-name') + ' | ' + text;
		this.element.find('.mp-category-heading').text(text);

		$.get('/make_product/base_products',
				_.object([$category.attr('data-group').toLowerCase()], [$category.attr('data-code')]),
				_.bind(function(products) {
			this._draw(products, function() {});
		}, this));

		$('#tab2').hide();
		$('#tab1').fadeIn();
	},

	_load: function(next) {
		next = next || function() {};
		var self = this;

		$.get('/make_product/base_products', function(products) {
//			self._draw(products, next);
			self._draw(products.data, next);//model.addAttribute("data", products); 변경으로 data 추가
		});
	},

	_draw: function(products, next) {
		next = next || function() {};

		var html = '';
		_.each(products, function(product) {
			html += '<li class="mp-product" data-id="' + product.id + '"><img src="' + product.filepath + '" alt="상품이미지"/><span class="pdtName">' + product[name_locale] + '</span></li>';
		});
		this.element.find('.mp-products').html('').append(html);

		next();
	},

	_select: function(e) {
		this._detail($(e.currentTarget).attr('data-id'));
	},

	_buttonClick: function(e) {
		var $button = $(e.currentTarget);
		if ($button.is('.cancel')) {
			$('#tab2').hide();
			$('#tab1').fadeIn();
		} else if ($button.is('.done')) {
//			$('#selectMenuLayer').hide();
//			$('#tab1').show();
//			$('#tab2').hide();

//			$('.mp-product-detail-colors').find('.color:eq(0)').click();

			$('.mp-editor').editor('option', 'selectedColorCode', this.option('selectedColorCode'));
			$('.mp-editor').editor('baseProduct', this.option('selectedProduct'));
//			$('.mp-editor').editor('selectColor', { colorCode: this.option('selectedColorCode') });

            $.get('/make/get_details', {
                base_product: this.option('selectedProduct').id
            }, function(html) {
                $('#detail').html(html);
            });
		}
	},

	_detail: function(productId) {
		var self = this;
		$.get('/make_product/base_product/' + productId, function(product) {
			$('#tab1').hide();
			self.option('selectedProduct', product);

			product = self.option('selectedProduct');

			var _colors = [];
			_.each(product.colors, function(color) {
				var _color = {};
				_color.code = color[0].color;
				_color.name = color[0].color_name;
				_colors.push(_color);
			});

			//var colorCodes = _.keys(product.colors);
			$('.mp-product-detail-colors').find('.color').remove();
			_.each(_colors, function(color) {
				$('.mp-product-detail-colors').prepend(
					'<li class="color" ' +
						'style="background-color: #' + color.code + '" ' +
						'data-color-code="' + color.code + '" title="' + color.name + '"><span></span></li>'
				);
			});

			$('#tab2')
				.find('.pdtImage img').attr('src', product.canvasInfo[0].filepath).end()
				.find('.pdtName').text(product[name_locale]).end()
				.find('.description').html(product[description_locale]).end()
				.find('.price').text(commify(product.priceInfo[0][solid_price_locale]) + '원 ~').end()
				.find('.infoImg').attr('src', product.size_filepath).end()
				.fadeIn();

			$('.mp-product-detail-colors').find('.color:eq(0)').click();
		});
	},

	selectColor: function(e) {
		var $color = $(e.currentTarget);
		$('.mp-product-detail-colors .color.current').removeClass('current');
		$color.addClass('current');
		this.option('selectedColorCode', $color.attr('data-color-code'));
		var product = this.option('selectedProduct');
		var sizes = _.pluck(_.filter(product.ori_sizes, function(size) { return _.contains(product.sizes, size.code) }), name_locale);
		if (sizes.length == 1) {
			$('#tab2')
				.find('.sizes').text(sizes[0]).end()
		} else {
			$('#tab2')
				.find('.sizes').text(sizes[0] + ' ~ ' + _.last(sizes)).end()
		}

		var colorCode = this.option('selectedColorCode');
		$('#tab2')
			.find('.pdtImage img').attr('src', _.first(_.sortBy(_.filter(product.fileInfo, function(fileInfo) {
				return fileInfo.color == colorCode;
			}), function(fileInfo) {
				return fileInfo.sort;
			})).filepath);

//		if () {
//			$('.mp-editor').editor('option', 'selectedColorCode', this.option('selectedColorCode'));
//			$('.mp-editor').editor('baseProduct', this.option('selectedProduct'));
//		}
	}
});

$.widget('mp.editor', {

	options: {
		baseProduct: null,
		selectedColorCode: '',
		selectedSize: '',
		currentCanvas: null,
		productId: null,
		faceChanging: false,
		isFirst: true
	},

	_create: function() {
//		this.element.find('.mp-editor-canvas').page({
//			change: function(event, ui) {
//				goods.history.add(ui.infos);
//			}
//		});
//		this.element.find('.mp-editor-canvas').hide().page('removeItems');
//		this.element.find('.mp-editor-canvas.front').addClass('current').show();

		this._on($('.mp-editor-colors'), {
			'click .color': 'selectColor'
		});

		this._on($('.mp-editor-sizes'), {
			change: '_changeSize'
		});

//		this._on($('.mp-editor-quantity'), {
//			change: '_changeQuantity'
//		});

		this.element.find('.mp-editor-quantity')
			.spinner({
				spin: $.proxy(this._changeQuantity, this)
			})
			.keyup(function() {
				if ($(this).val().length > 1 && $(this).val()[0] == '0') {
					$(this).val($(this).val().substr(1, $(this).val().length - 1));
				}
				$(this).val( $(this).val().replace(/[^0-9]/gi,"") );
			})
			.focus(function() {
				var self = this;
				setTimeout(function() {
					if (self.value == '0') {
						self.select();
					}
				}, 100);
			}).blur(_.bind(function(e, ui) {
				var $qu = $('.mp-editor-quantity');
				if (!$qu.spinner('value')) {
					$qu.spinner('value', 0);
				}
				this._changeQuantity(null, { value: $qu.spinner('value') });
			}, this));

		this._on($('.mp-editor-faces'), {
			'click .face': '_selectFace'
		});

		this._on($('.mp-editor-tools'), {
			'click .tool[data-tool="resizable"]': '_toggleResizable',
			'click .tool[data-tool="remove-black-background"]': '_removeBlackBackground',
			'click .tool[data-tool="remove-black-color"]': '_removeBlackColor',
			'click .tool[data-tool="remove-background"]': '_removeBackground',
			'click .tool[data-tool="remove-white-color"]': '_removeWhiteColor',
			'click .tool[data-tool="align-center"]': '_alignCenter',
			'click .tool[data-tool="valign-middle"]': '_valignMiddle',
			'click .tool[data-tool="undo"]': '_undo',
			'click .tool[data-tool="redo"]': '_redo',
			'click .tool[data-tool="trash"]': '_trash',
			'click .tool[data-tool="select-all"]': '_selectAll'
		});
		this.element.find('.size-info').hover($.proxy(function() {
			$('.size-info-img').attr('src', this.option('baseProduct').size_filepath).show();
		}, this), function() {
			$('.size-info-img').hide();
		});
	},

	baseProduct: function(baseProduct, next) {
		this.options.baseProduct = baseProduct;
		$('.mp-editor-name').text(baseProduct[name_locale]);
		var _colors = [];

		_.each(this.option('baseProduct').colors, function(color) {
			var _color = {};

			_color.code = color[0].color;
			_color.name = color[0].color_name;

			_colors.push(_color);
		});

		//console.log(_colors);

		//var colorCodes = _.keys(this.option('baseProduct').colors);
		$('.mp-editor-colors').find('.color').remove();
		_.each(_colors, function(color) {
			$('.mp-editor-colors').prepend(
				'<li class="color" ' +
					'style="background-color: #' + color.code + '" ' +
					'data-color-code="' + color.code + '" title="' + color.name + '" data-color-name="' + color.name + '"><span></span></li>'
			);
		});

		this.selectColor({
			colorCode: this.options.selectedColorCode ? this.options.selectedColorCode : _.last(_.keys(this.option('baseProduct').colors))
		}, true);
		this.options.selectedColorCode = null;

		var currentCanvasInfo = baseProduct.canvasInfo[0];
		this._drawImage({
			src: this.image(currentCanvasInfo.file_type),
			fileType: currentCanvasInfo.file_type,
			type: currentCanvasInfo.type,
			mainCanvasInfo: this._mainCanvasInfo(currentCanvasInfo.sort)
		}, $.proxy(function() {
			var $faces = $('.mp-editor-faces').html('');
			_.each(baseProduct.canvasInfo, function(canvas, i) {
				var $canvas = this.element.find('.mp-editor-canvas[data-file-type="' + canvas.file_type + '"]');
				if (!$canvas.length) {
					$canvas = this._createCanvas(canvas);
				}
				if (canvas.only_vector && !$canvas.find('.mp-only-vector').length)
					$canvas.append('<div class="mp-only-vector"><img src="/img/make/abletoprint.jpg" /></div>');
				else if (!canvas.only_vector && $canvas.find('.mp-only-vector').length)
					$canvas.find('.mp-only-vector').remove();

				$canvas.attr('data-sort', canvas.sort);
				var size = _.find(this.option('baseProduct').sizeInfo[canvas.file_type], function(size) {
					return size.code == $('.mp-editor-sizes').val();
				});
				$canvas.attr('data-real-size-width', size.width);
				$canvas.attr('data-real-size-height', size.height);
				$canvas.find('.cm').text(size.width + 'cm x ' + size.height + 'cm');
				var rect = _.pick(canvas, 'top', 'left', 'width', 'height');
				var $image = $('.mp-editor-image');
				if (canvas.type == 'SUB') {
					rect = {
						top: $image.height() / 2 - rect.height,
						left: $image.width() / 2 - rect.width,
						width: rect.width * 2,
						height: rect.height * 2
					};
				}
				$canvas.css(rect).appendTo($image);
				$canvas.addClass('isNew');

				this._createFace(canvas);
			}, this);

			this.element.find('.mp-editor-canvas:not(.isNew)').remove();
			this.element.find('.mp-editor-canvas').removeClass('isNew');
			goods.history.add([]);

			this.element.find('.mp-editor-canvas.current').removeClass('current');
			this.element.find('.mp-editor-canvas:eq(0)').addClass('current');
			$faces.find('.face:eq(0)').addClass('current');
			$('.mp-editor-tools').animate({top: $('.mp-editor-image').height() + 64, opacity: 1});

			if (this.option('isFirst')) {
				var query = QueryStringToJSON();
				if (query.design) {
					$('.mp-editor').editor('addItem', {
						type: 'design',
						src: query.design_path,
						id: query.design,
						mine: false,
						price: 0,
						price_en: 0,
						price_ko: 0
					});
				}
				this.option('isFirst', false);
			}

			if (next) next();
		}, this));
	},

	_createFace: function(canvas) {
		var $faces = $('.mp-editor-faces');
		var $face = $('#tFace').tmpl(canvas);
		var $faceImg = $face.find('img');
		if (canvas.type == "MAIN") {
			$face.appendTo($faces);
			return;
		}

		$faceImg.css({ visibility: 'hidden' });
		$faceImg.load($.proxy(function() {
			var mainCanvasFileType = $faces.find('.face[data-type="MAIN"]:last').attr('data-file-type');
			var mainCanvas = _.find(this.option('baseProduct').canvasInfo, function(canvas) {
				return canvas.file_type == mainCanvasFileType;
			});
			var center = {
				top: $faceImg.height(),
				left: $faceImg.width()
			};
			var offset = {
				top: $faceImg.height() / 2,
				left: $faceImg.width() / 2
			};
			var result1 = {
				top: -(center.top - offset.top),
				left: -(center.left - offset.left),
				width: '200%'
			};
			var center2 = {
				top: (mainCanvas.top + canvas.top) * 2 + (canvas.height),
				left: (mainCanvas.left + canvas.left) * 2 + (canvas.width)
			};

			var result2 = {
				top: center.top - center2.top,
				left: center.left - center2.left
			};
			result1.top += result2.top;
			result1.left += result2.left;

			var q = $faceImg.width() > $faceImg.height() ?
				80 / ($faceImg.width() * 2) : 80 / ($faceImg.width() * 2);

			result1.top = result1.top * q;
			result1.left = result1.left * q;

			$faceImg.css(result1);
			$faceImg.css({ visibility: 'visible' });
		}, this));
		$face.appendTo($faces);
	},

	_createCanvas: function(canvas) {
		var self = this;
		var change = canvas.type == 'MAIN' ? function(event, ui) {
			goods.history.add(ui.infos);
			var $canvas = $(event.target);
			if ($canvas.find('.goods-item').length == 0)
				self.refreshPrice();
		} : function(event, ui) {
			goods.history.add(ui.infos);
			var $canvas = $(event.target);
			var $mainCanvas = $canvas.prevAll('.mp-editor-canvas[data-type="MAIN"]');
			$mainCanvas.find('.goods-item[data-file-type="' + $canvas.attr('data-file-type') + '"]').remove();
			_.each(ui.infos, function(info) {
				info.style.width = parseInt(info.style.width, 10) / 2;
				info.style.height = parseInt(info.style.height, 10) / 2;
				if (!info.style.width || !info.style.height) return; // 아직 auto인 경우에 들어온 경우 처리, 리팩토링 필요, item.change관련 땜빵임.

				var subCanvas = _.find(self.option('baseProduct').canvasInfo, function(canvas) {
					return $canvas.attr('data-file-type') == canvas.file_type;
				});
				info.style.top = parseInt(info.style.top, 10) / 2 + subCanvas.top;
				info.style.left = parseInt(info.style.left, 10) / 2 +  subCanvas.left;
				info.editable = false;
				$mainCanvas.page('addItem', info); // TODO 여기 info price 등 검증하기
			});
		};

		var $canvas = $('<div class="mp-editor-canvas"><div class="cm"></div></div>')
			.attr('data-file-type', canvas.file_type)
			.attr('data-type', canvas.type)
			.page({
				change: change
			});
		if (canvas.only_vector)
			$canvas.append('<div class="mp-only-vector"><img src="/img/make/abletoprint.jpg" /></div>');
		return $canvas;
	},

	_drawImage: function(info, next) {
		next = next || function() {};

		var self = this;
		var $image = $('.mp-editor-image');
		var $background = $('.mp-editor-image').find('.mp-editor-image-background');

		$image.addClass('animating').css({ visibility: 'visible' }).animate({ opacity: 0 }, 200, function() {
			$background.remove();
			$background = $('<img class="mp-editor-image-background">');
			$background.load(function() {
				var $background = $('.mp-editor-image-background');
				$image.css({
					width: $background.width(),
					height: $background.height()
				});

				if (info.type == 'SUB') {
					$background.css('width', '200%');
					var currentCanvasInfo = _.find(self.option('baseProduct').canvasInfo, function(canvas) {
						return canvas.file_type == info.fileType
					});
					var center = {
						top: $background.height() / 2,
						left: $background.width() / 2
					};
					var offset = {
						top: $background.height() / 4,
						left: $background.width() / 4
					};
					var result1 = {
						top: -(center.top - offset.top),
						left: -(center.left - offset.left)
					};
					var center2 = {
						top: (info.mainCanvasInfo.top + currentCanvasInfo.top) * 2 + (currentCanvasInfo.height),
						left: (info.mainCanvasInfo.left + currentCanvasInfo.left) * 2 + (currentCanvasInfo.width)
					};
					var result2 = {
						top: center.top - center2.top,
						left: center.left - center2.left
					};
					result1.top += result2.top;
					result1.left += result2.left;

					$background.css(result1);
				}

				$image.animate({ opacity: 1 }, 500, function() {
					$image.removeClass('animating');
					self._colorSelecting = false;
				});
				next();
			}).appendTo($image).attr('src', info.src);

//			console.log($background, info.src);
		});
	},

	drawDesigns: function(designs) {
		// TODO 시연용 셋타임아웃
//		setTimeout(_.bind(function() {
			_.each(designs, function(design) {
				var info = {
					type: 'design',
					src: design.filepath,
					id: design.seller_designId,
					style: {
						top: design.top,
						left: design.left,
						width: design.width,
						height: design.height,
						rotate: design.rotate
					},
					originalWidth: design.design_width,
					originalHeight: design.design_height,
					resizable: design.resizable,
					price_ko: 0,
					price_ko: design.price_ko,
					price_en: design.price_en,
					mine: parseInt(design.userId) == parseInt($('#mp-login-user-id').text())
				};
				this.addItem(info, design.file_type);
			}, this);
//		}, this), 2000);
	},

	selectColor: function(arg, noDraw) {
		if (this._colorSelecting) return;
		this._colorSelecting = true;

		var self = this;
		var baseProduct = this.option('baseProduct');
		var colorCode = arg.colorCode || $(arg.currentTarget).attr('data-color-code');
		var colorInfos = baseProduct.colors[colorCode];
//		$('.mp-editor-sizes').html('<option value="none">사이즈 선택</option>');

		$('.mp-editor-sizes').html('');
		_.each(colorInfos, function(colorInfo) {
			var sizeName = self.sizeName(colorInfo.size);
			$('.mp-editor-sizes').append('<option value="' + colorInfo.size + '">' + sizeName + '</option>');
		});

		if (this.option('selectedSize')) {
			var optionEl = $('.mp-editor-sizes').find('option[value="' + this.option('selectedSize') + '"]').get(0);
			if (optionEl) {
				optionEl.selected = true;
			} else {
				$('.mp-editor-sizes').find('option:eq(0)')[0].selected = true;
				this.option('selectedSize', null);
			}
		} else {
			$('.mp-editor-sizes').find('option:eq(0)')[0].selected = true;
		}

		this._changeSize(true);

		$('.mp-editor-colors').find('.color.current').removeClass('current');

		var $color = $('.mp-editor-colors').find('.color[data-color-code="' + colorCode + '"]').addClass('current');
		$('.mp-color-name').text($color.attr('data-color-name'));

		if (!noDraw) {
			var $currentFace = $('.mp-editor-faces .face.current');
			this._drawImage({
				src: this.image($currentFace.attr('data-file-type')),
				fileType: $currentFace.attr('data-file-type'),
				type: $currentFace.attr('data-type'),
				mainCanvasInfo: this._mainCanvasInfo($currentFace.attr('data-sort'))
			});
		}

		this.refreshPrice();
	},

	_mainCanvasInfo: function(sort) {
		sort = sort + '';
		return _.find(this.option('baseProduct').canvasInfo, function(canvas) {
			return canvas.sort == sort.substr(0, 1) + '00';
		})
	},

	sizeName: function(sizeCode) {
		return _.find(this.option('baseProduct').ori_sizes, function(size) { return size.code == sizeCode })[name_locale];
	},

	image: function(type) {
		var baseProduct = this.option('baseProduct');
		var currentColorCode = this._currentColorCode();
//		console.log('hi~', currentColorCode);

		var info = _.find(baseProduct.fileInfo, function(info) {
			return info.color == currentColorCode && info.type == type;
		}) || { filepath: '' };
		return info.filepath;
	},

	_currentColorCode: function() {
		return $('.mp-editor-colors').find('.color.current').attr('data-color-code');
	},

	_selectFace: function(e) {
		if (this.option('faceChanging')) return;

		this.option('faceChanging', true);
		$('.mp-editor-faces')
			.find('.face.current').removeClass('current');

		var type = $(e.currentTarget).addClass('current').attr('data-file-type');
		this._drawImage({
			src: this.image(type),
			fileType: type,
			type: $(e.currentTarget).attr('data-type'),
			mainCanvasInfo: this._mainCanvasInfo($(e.currentTarget).attr('data-sort'))
		}, $.proxy(function() {
			this.element.find('.mp-editor-canvas').removeClass('current');
			var $canvas = this.element.find('.mp-editor-canvas[data-file-type="' + type + '"]').addClass('current');
			goods.history.init($canvas.page('infos'));
			$('.mp-editor-tools').animate({top: $('.mp-editor-image').height() + 64, opacity: 1});
			this.option('faceChanging', false);
		}, this));
	},

	_changeSize: function(noRefresh) {
		_.each($('.mp-editor-canvas').get(), function(el) {
			var $canvas = $(el);
			var size = _.find(this.option('baseProduct').sizeInfo[$canvas.attr('data-file-type')], function(size) {
				return size.code == $('.mp-editor-sizes').val();
			});
			if (size) {
				$canvas.attr('data-real-size-width', size.width);
				$canvas.attr('data-real-size-height', size.height);
				$canvas.find('.cm').text(size.width + 'cm x ' + size.height + 'cm');

				$canvas.find('.goods-item').each(function() {
					var $item = $(this);
					var originalWidth = $item.item('info').originalWidth;
					$item.item('option', { maxWidth: (originalWidth / ((parseInt($canvas.attr('data-real-size-width')) * 43)) * $canvas.width()) });
					$item.item('refreshMaxWidth');
				});
			}
		}, this);

		this.option('selectedSize', $('.mp-editor-sizes').val());

		if (noRefresh !== true) this.refreshPrice();
	},

	_changeQuantity: function(event, ui) {
		if (ui.value < 0) {
			$('.mp-editor-quantity').spinner('value', 0);
			this.refreshPrice();
			return false;
		}
		// 200 제한
		if (ui.value >= 200) {
			$('.mp-editor-quantity').spinner('value', 200);
			this.refreshPrice();
			return false;
		}
		this.refreshPrice();
	},

	refreshPrice: function() {
		var currentColorCode = this._currentColorCode();
		if (!currentColorCode) return;

		var colorInfo =
			_.find(this.option('baseProduct').colors[currentColorCode], function(info) {
				return info.size == $('.mp-editor-sizes').val()
			});

		var priceText = l('기본 가격 %s원', commify(colorInfo[solid_price_locale]));
		var price = colorInfo[solid_price_locale];
		var price_ko = colorInfo.solid_price_ko;
		var price_en = colorInfo.solid_price_en;

		_.each($('.mp-editor-canvas').get(), function(canvas, i) {
			if ($(canvas).find('.goods-item').length && this.option('baseProduct').canvasInfo[i]) {
				var _price = this.option('baseProduct').canvasInfo[i][price_locale];
				var _price_ko = this.option('baseProduct').canvasInfo[i].price_ko;
				var _price_en = this.option('baseProduct').canvasInfo[i].price_en;
				price += _price;
				price_ko += _price_ko;
				price_en += _price_en;
				priceText += '<br>' + l('%s 인쇄 %s원', this.option('baseProduct').canvasInfo[i][name_locale], commify(_price));
			}
		}, this);

		// 컬러별 옵션 가격
		if ($('.mp-editor-canvas .goods-item').length && colorInfo[extra1_locale]) {
			price += colorInfo[extra1_locale];
			price_ko += colorInfo.extra1_ko;
			price_en += colorInfo.extra1_en;
			priceText += '<br>' + l('컬러티셔츠 인쇄 %s원', commify(colorInfo[extra1_locale])) + '<img src="../img/make/question.png" title="' + l('인쇄할 티셔츠가 컬러인 경우에 추가되는 가격입니다. (블랙 포함)') + '">';
		}

		// 디자이너 스토어 가격
		var storePrice = 0;
		var storePrice_ko = 0;
		var storePrice_en = 0;
		$('.mp-editor-canvas .goods-item').each(function() {
			var $item = $(this);
			storePrice += $item.item('info').price;
			storePrice_ko += $item.item('info').price_ko;
			storePrice_en += $item.item('info').price_en;
		});
		if (storePrice > 0) {
			price += storePrice;
			price_ko += storePrice_ko;
			price_en += storePrice_en;
			priceText += '<br>' + l('디자이너 스토어 %s원', commify(storePrice));
		}

		// for jquery ui spinner bug
		setTimeout(function() {
			var quantity = parseInt($('.mp-editor-quantity').spinner('value'), 10);
			priceText += '<br><strong>' + l('합계 %s원', commify((price * quantity))) + '</strong>' + ' (' + l('수량 %s개', quantity)+ ')';
			$('.mp-editor-price')
				.attr('data-price', price)
				.attr('data-price-ko', price_ko)
				.attr('data-price-en', price_en)
				.html(priceText);
		}, 100);
	},

	addItem: function(option, fileType) {
		var $canvas;
		if (fileType) {
			option.fileType = fileType;
			var canvas = _.find(this.option('baseProduct').canvasInfo, function(canvas) {
				return canvas.file_type == fileType;
			});
			option.canvasType = canvas.type;
			$canvas = $('.mp-editor-canvas[data-file-type="' + fileType + '"]');
		}  else {
			option.fileType = $('.mp-editor-canvas.current').attr('data-file-type');
			option.canvasType = $('.mp-editor-canvas.current').attr('data-type');
			$canvas = $('.mp-editor-canvas.current');
		}

		if ($canvas.find('.goods-item.design').length < 3) {
			var originalWidth = parseInt(option.originalWidth);
			if (originalWidth) {
				option.maxWidth = (option.originalWidth / ((parseInt($canvas.attr('data-real-size-width')) * 43)) * $canvas.width());
			}
			$canvas.page('addItem', option);
			this.refreshPrice();
		} else {
			showAlert(l('한면에 디자인을 3개 이상 추가할 수 없습니다.'));
		}
	},

	_toggleResizable: function(e) {
		var $msItems = $('.mp-editor-canvas.current .goods-item.ms');
		if ($msItems.length) {
			showAlert(l('아이템을 하나만 선택하신 후 다시 시도해주세요.'));
			return;
		}

		var $item = $('.mp-editor-canvas.current .goods-item.selected');
//		var designInfo = $item.item('info');
		$item.item('toggleResizable');
	},

	_removeBlackBackground: function(e) {
		this._removeBackground(null, 'black');
	},

	_removeBackground: function(e, color) {
		var $msItems = $('.mp-editor-canvas.current .goods-item.ms');
		if ($msItems.length) {
			showAlert(l('아이템을 하나만 선택하신 후 다시 시도해주세요.'));
			return;
		}
		var $item = $('.mp-editor-canvas.current .goods-item.selected');
		if (!$item.length) return;
		if ($item.is('[data-mine="false"]')) {
			showAlert(l('흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.'));
			return;
		}
		var designInfo = $item.item('info');

		var prevFuzz = $item.data('fuzz') || 5;
		$.post('/mygm/remove_background', {
			src: designInfo.src.split('?')[0],
			fuzz: prevFuzz + '%',
			color: color ? color : 'white'
		}, function(data) {
			// TODO 뭔가 명확히 해결 필요
			if (!$item.data('fuzz')) {
				goods.history.add({
					type: 'remove-background',
					prevSrc: data.prevSrc,
					prevFuzz: prevFuzz,
					id: designInfo.id
				});
			}
			goods.history.add({
				type: 'remove-background',
				prevSrc: data.prevSrc,
				prevFuzz: prevFuzz,
				id: designInfo.id
			});
			var url = designInfo.src + '?time=' + (new Date()).getTime();
			$item.item('option', { src: url });
			$item.data('fuzz', prevFuzz + 5);
		});
	},

	_removeBlackColor: function(e) {
		this._removeWhiteColor(null, 'black');
	},

	_removeWhiteColor: function(e, color) {
		var $msItems = $('.mp-editor-canvas.current .goods-item.ms');
		if ($msItems.length) {
			showAlert(l('아이템을 하나만 선택하신 후 다시 시도해주세요.'));
			return;
		}
		var $item = $('.mp-editor-canvas.current .goods-item.selected');
		if (!$item.length) return;
		if ($item.is('[data-mine="false"]')) {
			showAlert(l('흰색 지우기는 고객님께서 업로드한 이미지인 경우에만 사용 가능합니다.'));
			return;
		}

		var designInfo = $item.item('info');
		var prevFuzz = $item.data('fuzz') || 5;
		$.post('/mygm/remove_white_color', {
			src: designInfo.src.split('?')[0],
			fuzz: prevFuzz + '%',
			color: color ? color : 'white'
		}, function(data) {
			// TODO 뭔가 명확히 해결 필요
			if (!$item.data('fuzz')) {
				goods.history.add({
					type: 'remove-white-color',
					prevSrc: data.prevSrc,
					prevFuzz: prevFuzz,
					id: designInfo.id
				});
			}
			goods.history.add({
				type: 'remove-white-color',
				prevSrc: data.prevSrc,
				prevFuzz: prevFuzz,
				id: designInfo.id
			});
			var url = designInfo.src + '?time=' + (new Date()).getTime();
			$item.item('option', { src: url });
//			$item.find('img').attr('src', url);
			$item.data('fuzz', prevFuzz + 5);
		});
	},

	_alignCenter: function() {
		this._align('left', 'width');
	},

	_valignMiddle: function() {
		this._align('top', 'height');
	},

	_align: function(key1, key2) {
		var $canvas = this.element.find('.mp-editor-canvas.current');
		var $selectedItem = $canvas.find('.goods-item.ms').length ?
			$canvas.find('.goods-item.ms') : $canvas.find('.goods-item.selected');
		var style = {};
		style[key1] = ($canvas[key2]() / 2) - ($selectedItem[key2]() / 2);
		$selectedItem.item('option', { style: style });
	},

	_undo: function() {
		undo();
	},

	_redo: function() {
		redo();
	},

	_trash: function() {
		trash();
	},

	_selectAll: function() {
		selectAll();
	},

	sync: function(next) {
		var self = this;
		var baseProduct = this.option('baseProduct');

		$.post('/make_product/product', {
			base_productId: baseProduct.id,
			name: '상품 만들기 제품',
			color: this._currentColorCode(),
			size: $('.mp-editor-sizes').val(),
			//price: parseInt($('.mp-editor-price').attr('data-price'), 10),
			price_ko: parseInt($('.mp-editor-price').attr('data-price-ko'), 10),
			price_en: parseInt($('.mp-editor-price').attr('data-price-en'), 10)
		}, function(data) {
			self.option('productId', data.productId);
			var productId = data.productId;
			var productPriceId = data.product_price.id;
			self._syncProductDesigns(function(thumbnailDesigns, designs) {
				var firstImage = self.image($('.mp-editor-faces .face:eq(0)').attr('data-file-type'));
				$.post('/mygm/thumbnail', {
					thumbnailDesigns: thumbnailDesigns,
					firstImage: firstImage,
					file_type: $('.mp-editor-faces .face:eq(0)').attr('data-file-type'),
					firstImagePosition: {
						top: baseProduct.canvasInfo[0].top,
						left: baseProduct.canvasInfo[0].left
					},
					productId: productId
				}, function(data) {
					var thumbnail = data.thumbnail;
					$.post('/make_product/product/' + productId + '/thumbnail', {
						url: thumbnail
					}, function(data) {
						$.post('/add_cart', {
							product_id: productId,
							product_price_id: productPriceId,
							quantity: $('.mp-editor-quantity').spinner('value')
						}, function(data) {
							if (data.result === true) {
								var basket = data.basket;
								basket.filepath = thumbnail;
								basket.size = $('.mp-editor').editor('sizeName', $('.mp-editor-sizes').val());
								$('.mp-cart').cart('add', basket);
								next();
							}
						});
					});

					$.post('/mygm/product_images', {
						productId: productId,
						designs: designs
					}, function(data) {
					});

					$.post('/mygm/print_images', {
						productId: productId,
						designs: designs
					}, function(data) {
					});
				});
			});
		});
	},

	_syncProductDesigns: function(next) {
		var self = this;
		var i = 0;
		var $items = $('.mp-editor-canvas').find('.goods-item');
		var length = $items.length;

		var thumbnailDesigns = [];
		var firstCanvas = _.clone(this.option('baseProduct').canvasInfo[0]);
		var designs = [{
			canvas: _.extend(firstCanvas, {
				filepath: this.image(firstCanvas.file_type)
			}),
			realSize: {
				width: $('.mp-editor-canvas:eq(0)').attr('data-real-size-width'),
				height: $('.mp-editor-canvas:eq(0)').attr('data-real-size-height')
			},
			designs: []
		}];

		if (length == 0) {
			next(thumbnailDesigns, designs);
			return;
		}

		var _sync = function(i) {
			var $canvas = $items.eq(i).parents('.mp-editor-canvas');
			var file_type = $canvas.attr('data-file-type');

			if (_.last(designs).canvas.file_type != file_type) {
				_.last(designs).designs = _.sortBy(_.last(designs).designs, function(design) {
					return design.zIndex;
				});
				var canvas = _.extend(_.clone(_.find(self.option('baseProduct').canvasInfo, function(canvas) {
					return canvas.file_type == file_type;
				})), {
					filepath: self.image(file_type)
				});
				designs.push({
					canvas: canvas,
					realSize: {
						width: $canvas.attr('data-real-size-width'),
						height: $canvas.attr('data-real-size-height')
					},
					designs: []
				});
			}

//			var rect = {
//				top: parseInt($items.eq(i).item('info').style.top, 10),
//				left: parseInt($items.eq(i).item('info').style.left, 10),
//				width: parseInt($items.eq(i).item('info').style.width, 10),
//				height: parseInt($items.eq(i).item('info').style.height, 10),
//				rotate: parseInt($items.eq(i).item('info').style.rotate, 10)
//			};
			var rect = {
				top: parseFloat($items.eq(i).item('info').style.top),
				left: parseFloat($items.eq(i).item('info').style.left),
				width: parseFloat($items.eq(i).item('info').style.width),
				height: parseFloat($items.eq(i).item('info').style.height),
				rotate: parseInt($items.eq(i).item('info').style.rotate)
			};
			var body = _.extend({
				seller_designId: parseInt($items.eq(i).item('info').id, 10),
				file_type: file_type,
				resizable: $items.eq(i).item('info').resizable
			}, rect);

			var design = {
				path: $items.eq(i).item('info').src.split('?time=')[0],
				rect: {
					top: $items.eq(i).position().top,
					left: $items.eq(i).position().left,
					width: ($items.eq(i)[0].getBoundingClientRect().width || rect.width),
					height: ($items.eq(i)[0].getBoundingClientRect().height || rect.height)
				},
				rotate: parseInt($items.eq(i).item('info').style.rotate, 10),
				zIndex: parseInt($items.eq(i).css('zIndex'), 10)
			};

			if (file_type == self.option('baseProduct').canvasInfo[0].file_type) {
				thumbnailDesigns.push(design);
			}
			_.last(designs).designs.push(design);

			$.post('/product/' + self.option('productId') + '/designs', body, function(data) {
				i++;
				if (i == length) {
					next(
						_.sortBy(thumbnailDesigns, function(design) {
							return design.zIndex;
						}),
						designs
					);
					return;
				}
				_sync(i);
			});
		};
		_sync(i);
	}
});

$.widget('mp.cart', {

	options: {
		prevCount: 0
	},

	_create: function() {
		var self = this;
		$(document).click(function(e) {
			if ($(e.target).is('.mp-cart') || $(e.target).is('.mp-cart *')) return;

			self.element.find('.product').removeClass('editable');
			self._hide();
		});

		this._on(this.element, {
			'click .icon': '_iconClick',
//			'mouseout': '_iconClick',
			'click .option': '_optionClick',
			'click .edit-quantity button': '_chageQuantity',
			'keyup input.quantity': function(e) {
				var $input = $(e.target);
				if ($input.val().length > 1 && $input.val()[0] == '0') {
					$input.val($input.val().substr(1, $input.val().length - 1));
				}
				if ($input.val().replace(/[^0-9]/gi,"").length == 0) {
					$input.val('');
					return;
				}
				var q = Math.max(1, parseInt($input.val().replace(/[^0-9]/gi,"")) || 1);
				$input.val(q);
			},
			'click .remove': '_remove'
		});

		this.element.hover($.proxy(this._iconHover, this), $.proxy(this._iconHover, this));
		this._load();
	},

	_load: function() {
		var self = this;
		setTimeout(function() {
			$.get('/cart?json=1', function(baskets) {
				var $products = self.element.find('.products');
//				alert($products.id);
//				_.each(baskets, function(product) {//원래 데이터가 baskets:로 시작함. baskets가 id로 시작됨 하지만... 방식 수정 model.addAttribute("data", products);
//				alert(baskets.data[0].size);
				_.each(baskets.data, function(product) {
					var $product = $('#tProduct').tmpl(product);
					$product.appendTo($products.hide());
				});
				$products.fadeIn(function() {
					self._refresh();
				});
			});
		}, 1300);
	},

	_refresh: function() {
		var currentCount = this.element.find('.product').length;
		var $count = this.element.find('.icon .count').text(currentCount);
		if (this.option('prevCount') < currentCount) {
			$count.animate({
				top: -26,
				opacity: 1
			}, 200, function() {
				$count.animate({
					top: -16
				}, 200);
			});
		} else if (currentCount == 0) {
			$count.animate({
				top: -26
			}, 200, function() {
				$count.animate({
					top: 0,
					opacity: 0
				}, 200);
			});
		}
		setTimeout(_.bind(function() {
			this.element.find('.body').scrollTop(100000);
		}, this), 100);
		this.option('prevCount', currentCount);
	},

	_iconHover: function() {
		if (this.element.width() == 0) {
			this.element.animate({width: 110}, 150);
		} else {
			this._hide();
		}
	},

	_iconClick: function() {
		location.href = '/cart';
	},

	_hide: function() {
		this.element.animate({width: 0}, 150);
	},

	_optionClick: function(e) {
		var $product = $(e.currentTarget).parents('.product');
		this.element.find('input.quantity').val(this.element.find('.quantity').text());
		if ($product.is('.editable')) {
			$product.find('.options').animate({
				height: 1
			}, 200, function() {
				$product.toggleClass('editable');
			});
		} else {
			$product.toggleClass('editable');
			$product.find('.options').animate({
				height: 62
			}, 200);
		}
	},

	_chageQuantity: function(e) {
		var $product = $(e.currentTarget).parents('.product');
		var quantity = parseInt($product.find('input.quantity').val());
		if (quantity < -1) {

		}
		$.post('/modify_quantity', {
			id: $(e.currentTarget).attr('data-basket-id'),
			quantity: quantity
		}, function(data) {
			if (data.result)
				$product.find('.info .quantity').text(quantity);
			else
				showAlert(l('상품 수량 변경시 에러가 발생하였습니다.'));

			$product.removeClass('editable');
		});
	},

	_remove: function(e) {
		if (!confirm('삭제하시겠습니까?')) return;
		var self = this;
		var $product = $(e.currentTarget).parents('.product');
		$.post('/remove_cart', {
			id: $product.attr('data-basket-id')
		}, function(data) {
			if (data.result) {
				$product.fadeOut(function() {
					$(this).remove();
					self._refresh();
				});
			} else
				showAlert(l('삭제시 에러가 발생하였습니다.'));
		});
	},

	add: function(product) {
		var $product = $('#tProduct').tmpl(product).css({ opacity: 0 });
		$product.appendTo(this.element.find('.products')).animate({
			opacity: 1
		}, 200);
		this._refresh();
	}

});

function QueryStringToJSON() {
	var pairs = location.search.slice(1).split('&');

	var result = {};
	_.each(pairs, function(pair) {
		pair = pair.split('=');
		result[pair[0]] = decodeURIComponent(pair[1] || '');
	});

	return JSON.parse(JSON.stringify(result));
}

$(function() {
	window.name_locale = 'name' + $('body').attr('data-_locale');
	window.description_locale = 'description' + $('body').attr('data-_locale');
	window.solid_price_locale = 'solid_price' + $('body').attr('data-_locale');
	window.extra1_locale = 'extra1' + $('body').attr('data-_locale');
	window.price_locale = 'price' + $('body').attr('data-_locale');

	$(window).resize(function() {
		$('#freeDesignLayer').designsController('showImage');
		$('#loadImageWrapper').designsController('showImage');
	});
	$('.mp-editor').editor();
	$('#selectMenuLayer').productsController({
		query: QueryStringToJSON()
	});
	$('#freeDesignLayer').designsController({
		api: '/make_product/free_designs'
	});
	$('#loadImageWrapper').designsController({
		api: '/make_product/free_designs'
	});
	$('#addTextWrapper').textController();
	$('.mp-cart').cart();
	$('button.addCart').click(function() {
		if (checkOverflowAllItem()) {
			showAlert(l('인쇄 영역을 넘어간 이미지가 있습니다.'));
			return;
		}
		if ($('.mp-editor-quantity').spinner('value') == 0) {
			showAlert(l('수량을 입력해주세요.'));
			return;
		}
		if ($('button.addCart .text').text() == l('담는중...')) return;
		$('button.addCart .text').text(l('담는중...'));
		$('#cancel-click').show();
		$('.mp-editor').editor('sync', function() {
			$('.mp-editor-sizes').val($('.mp-editor-sizes option:first').val());
			$('.mp-editor-quantity').spinner('value', 0).change();
			$('button.addCart .text').text(l('장바구니 담기'));
			$('#cancel-click').hide();
		});
	});
	$('button.cart').click(function() {
		if (checkOverflowAllItem()) {
			showAlert(l('인쇄 영역을 넘어간 이미지가 있습니다.'));
			return;
		}
		if ($('.mp-editor-quantity').spinner('value') == 0) {
			showAlert(l('수량을 입력해주세요.'));
			return;
		}
		if ($('.mp-editor-quantity').spinner('value') > 0) {
			if ($('button.addCart .text').text() == l('담는중...')) return;
			$('button.addCart .text').text(l('담는중...'));
			$('#cancel-click').show();
			$('.mp-editor').editor('sync', function() {
				$('.mp-editor-sizes').val($('.mp-editor-sizes option:first').val());
				$('.mp-editor-quantity').spinner('value', 0).change();
				$('button.addCart .text').text(l('장바구니 담기'));
				location.href = '/cart';
				$('#cancel-click').hide();
			});
			return;
		}
		location.href = '/cart';
	});
	goods.keyboard.ready();


});

$(function() {
    $('.mp-context-menu li').mousedown(function(e) {
        var $menu = $(this);
        if ($menu.hasClass('forward')) {
            $('.mp-editor-canvas.current').page('forwardItem', $('.goods-item.selected'));
        } else if ($menu.hasClass('backward')) {
            $('.mp-editor-canvas.current').page('backwardItem', $('.goods-item.selected'));
        } else if ($menu.hasClass('delete')) {
            $('.goods-item.selected').item('remove');
        } else if ($menu.hasClass('copy')) {
            var infos = [];
            $('.goods-item.selected').each(function() {
                infos.push($(this).item('info'));
            });
            goods.keyboard.clipboard(infos);
        }
    });

	$('.menuLayer')
		.find('.close').click(function() {
			$(this).parents('.menuLayer').hide();
			$('.sideMenu .menu.selected').removeClass('selected');
		});

	$(document).click(function(e) {
		if ($(e.target).hasClass('menuLayer') ||
			$(e.target).hasClass('sideMenu') ||
			$(e.target).parents('.menuLayer').length ||
			$(e.target).parents('.sideMenu').length ||
			$(e.target).parents('.mp-editor-tools').length ||
			$(e.target).parents('.mp-editor-colors').length ||
			$(e.target).parents('#pdtFaces').length) return;

		$('.menuLayer').hide();
		$('.sideMenu .menu.selected').removeClass('selected');
	});

	$('.sideMenu .menu').click(function() {
		if ($(this).is('.selected')) {
			if ($(this).is('.selectPdt')) {
				$('#tab2').hide();
				$('#tab1').fadeIn();
			}
			return false;
		}

		$('.sideMenu .menu.selected').removeClass('selected');
		$(this).addClass('selected');
		$('.menuLayer').hide();
		$($(this).find('a').attr('href')).show().find('.mp-text-value').focus();
		$($(this).find('a').attr('href')).find('.mp-designs-container').scroll();

		return false;
	});

	$('.go-detail').click(function() {
		$('html, body').animate({
			scrollTop: 800
		}, 700);
	});
});

$(function() {
	if (location.href.indexOf('make_product') != -1)
		$(document).tooltip();
});



